# 低噪 Mask 分布分析

## 当前多图节点（wan_multi_frame.py）的低噪 Mask 分布

### 基本设置
- **默认参数**：
  - `ref_strength_low = 0.2` → mask = 1.0 - 0.2 = **0.8**
  - `start_frame_strength_low = 1.0` → mask = 1.0 - 1.0 = **0.0**
  - `end_frame_strength_low = 1.0` → mask = 1.0 - 1.0 = **0.0**

### Mask 分布情况（假设有3个参考帧，位置为 0, 40, 80）

#### 首帧（frame_idx = 0）
- **范围**：`[0:4]`
- **Mask 值**：**0.0** (完全强制参考)
- **说明**：首帧位置 mask 为 0，强制使用参考图

#### 中间参考帧（frame_idx = 40）
- **范围**：`[40:44]`
- **Mask 值**：**0.8** (ref_strength_low = 0.2)
- **说明**：中间帧位置 mask 为 0.8，相对宽松

#### 末帧（frame_idx = 80）
- **范围**：`[-4:]` (最后4帧)
- **Mask 值**：**0.0** (完全强制参考)
- **说明**：末帧位置 mask 为 0，强制使用参考图

### 问题分析：参考帧位置的闪烁

#### 问题1：参考帧之间没有平滑过渡
- **当前状态**：参考帧之间的 mask 值直接从 0.8 跳到 0.0 或反之
- **原因**：**没有低噪平滑逻辑**
- **影响**：在参考帧位置（frame_idx, frame_idx+1, frame_idx+2, frame_idx+3）会有突然的 mask 值变化，导致条件注入突变，产生闪烁

#### 问题2：参考帧边界不连续
- **示例**：
  - frame 39: mask = 0.8 (中间帧的边界)
  - frame 40: mask = 0.8 (中间帧本身，但可能已经到边界)
  - frame 44: mask = 0.8 (中间帧结束边界)
  - frame 45: mask = 1.0 (过渡区域，但没有任何平滑)
  
- **问题**：frame 44 到 frame 45 之间，mask 从 0.8 突然跳到 1.0，没有平滑过渡

#### 问题3：与三图节点的差异
- **三图节点**：有完整的低噪平滑逻辑（238-285行）
  - 在首帧-中间帧之间：平滑过渡
  - 在中间帧-末帧之间：平滑过渡
  - 使用 `time_weight` 和 `protect_weight` 创建平滑梯度

- **多图节点**：**完全没有低噪平滑逻辑**
  - 只在设置参考帧位置的 mask 值
  - 参考帧之间直接是默认的 mask = 1.0
  - 没有平滑过渡

### 修复建议

1. **添加低噪平滑逻辑**：参考三图节点的实现（238-285行）
2. **在参考帧之间创建平滑过渡**：使用 `time_weight` 和 `protect_weight`
3. **保护参考帧位置**：使用 `protect_zone_size` 保护参考帧附近的区域
4. **平滑 mask 值**：在参考帧之间插值 mask 值，避免突然跳跃

### 低噪 Mask 理想分布（修复后）

```
帧位置: 0    4    38   42   44   76   80   84
Mask:   0.0  0.0  ...  0.8  0.8  ...  0.0  0.0
        └─首帧─┘      └─中间帧─┘      └─末帧─┘
             ↓              ↓              ↓
        平滑过渡       平滑过渡       平滑过渡
```

### 关键代码位置

- **三图节点低噪平滑逻辑**：`wan_first_middle_last.py` 第 238-285 行
- **多图节点低噪设置**：`wan_multi_frame.py` 第 94-117 行（**缺少平滑逻辑**）

